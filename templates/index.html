{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>æ‰€æœ‰è´¦å•</h2>
            <a href="{{ url_for('add_bill') }}" class="btn btn-primary">æ·»åŠ æ–°è´¦å•</a>
        </div>

        {% if bills %}
            <div class="row">
                {% for bill in bills %}
                    <div class="col-md-6 mb-3">
                        {% set progress = bill.get_settlement_progress() %}
                        {% set settlement_status = bill.get_settlement_status() %}
                        {% set non_payer_settled = progress.settled - 1 %}
                        {% set non_payer_total = progress.total - 1 %}
                        <div class="card {% if bill.is_settled %}border-success{% elif non_payer_settled > 0 %}border-warning{% else %}border-warning{% endif %}" id="bill-{{ bill.id }}-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title">{{ bill.description }}</h5>
                                        <p class="card-text">
                                            <strong>é‡‘é¢ï¼š</strong>Â¥{{ "%.2f"|format(bill.amount) }}<br>
                                            <strong>ä»˜æ¬¾äººï¼š</strong>{{ bill.payer.display_name }}<br>
                                            <strong>è´¦å•æ—¥æœŸï¼š</strong>{{ bill.date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}<br>
                                            <strong>æ¯äººåº”ä»˜ï¼š</strong>Â¥{{ "%.2f"|format(bill.get_split_amount()) }}
                                        </p>
                                    </div>
                                    <div>
                                        {% if bill.is_settled %}
                                            <span id="bill-{{ bill.id }}-status" class="badge bg-success">å…¨éƒ¨ç»“ç®—</span>
                                        {% elif non_payer_settled > 0 and non_payer_settled < non_payer_total %}
                                            <span id="bill-{{ bill.id }}-status" class="badge bg-warning">éƒ¨åˆ†ç»“ç®—</span>
                                        {% elif non_payer_settled == non_payer_total and non_payer_total > 0 %}
                                            <span id="bill-{{ bill.id }}-status" class="badge bg-success">å…¨éƒ¨ç»“ç®—</span>
                                        {% else %}
                                            <span id="bill-{{ bill.id }}-status" class="badge bg-danger">æœªç»“ç®—</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- ç»“ç®—è¿›åº¦æ¡ -->
                                <div class="mt-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-muted">ç»“ç®—è¿›åº¦</small>
                                        <small class="text-muted" id="bill-{{ bill.id }}-progress-text">{{ progress.settled }}/{{ progress.total }}äºº</small>
                                    </div>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             id="bill-{{ bill.id }}-progress-bar"
                                             style="width: {{ progress.percentage }}%"></div>
                                    </div>
                                </div>

                                <!-- å‚ä¸è€…ç»“ç®—çŠ¶æ€ -->
                                <div class="mt-3">
                                    <h6 class="small mb-2">å‚ä¸è€…çŠ¶æ€ï¼š</h6>
                                    <div class="row">
                                        {% for user_id, status in settlement_status.items() %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <span id="bill-{{ bill.id }}-user-{{ user_id }}-icon">
                                                            {% if status.is_settled %}
                                                                <i class="bi bi-check-circle-fill text-success me-1"></i>
                                                            {% else %}
                                                                <i class="bi bi-clock text-warning me-1"></i>
                                                            {% endif %}
                                                        </span>
                                                        <small>
                                                            {{ status.user.display_name }}
                                                            {% if status.is_payer %}(ä»˜æ¬¾äºº){% endif %}
                                                        </small>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        {% if status.is_payer %}
                                                            <small class="text-muted">-</small>
                                                        {% else %}
                                                            <span id="bill-{{ bill.id }}-user-{{ user_id }}-amount">
                                                                {% if status.is_settled %}
                                                                    <small class="text-success">Â¥{{ "%.2f"|format(status.expected_amount) }}</small>
                                                                {% else %}
                                                                    <small class="text-danger">Â¥{{ "%.2f"|format(status.expected_amount) }}</small>
                                                                {% endif %}
                                                            </span>
                                                            {% if bill.payer_id == current_user.id %}
                                                                <button id="bill-{{ bill.id }}-user-{{ user_id }}-btn"
                                                                        class="btn btn-sm {% if status.is_settled %}btn-outline-warning{% else %}btn-outline-success{% endif %} px-1 py-0 ms-1"
                                                                        style="font-size: {% if status.is_settled %}0.6rem{% else %}0.7rem{% endif %};"
                                                                        onclick="return settleIndividual({{ bill.id }}, {{ user_id }}, '{{ status.user.display_name }}')">
                                                                    {% if status.is_settled %}æ’¤é”€{% else %}âœ“{% endif %}
                                                                </button>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- æ•´ä½“æ“ä½œæŒ‰é’® -->
                                <div class="mt-3 pt-2 border-top">
                                    <!-- æŸ¥çœ‹å‡­è¯æŒ‰é’® -->
                                    {% if bill.receipt_filename %}
                                        <button type="button" class="btn btn-sm btn-info me-1"
                                                onclick="viewReceipt({{ bill.id }})">
                                            <i class="bi bi-file-earmark-text"></i> æŸ¥çœ‹å‡­è¯
                                        </button>
                                    {% endif %}

                                    {% if bill.payer_id == current_user.id %}
                                        {% if not bill.is_settled %}
                                            <button id="bill-{{ bill.id }}-toggle-btn"
                                                    class="btn btn-sm btn-success me-1"
                                                    onclick="return toggleBillSettlement({{ bill.id }}, false)">
                                                å…¨éƒ¨ç»“ç®—
                                            </button>
                                        {% else %}
                                            <button id="bill-{{ bill.id }}-toggle-btn"
                                                    class="btn btn-sm btn-outline-warning me-1"
                                                    onclick="return toggleBillSettlement({{ bill.id }}, true)">
                                                å…¨éƒ¨æ’¤é”€
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <div class="alert alert-info py-2 mb-0 alert-dismissible fade show">
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                åªæœ‰è´¦å•åˆ›å»ºè€…ï¼ˆ{{ bill.payer.display_name }}ï¼‰å¯ä»¥ç®¡ç†ç»“ç®—çŠ¶æ€
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <h4 class="text-muted">è¿˜æ²¡æœ‰è´¦å•è®°å½•</h4>
                <p class="text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ç¬”è´¦å•å§ï¼</p>
                <a href="{{ url_for('add_bill') }}" class="btn btn-primary">æ·»åŠ è´¦å•</a>
            </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æˆ‘çš„å€ºåŠ¡å…³ç³»</h5>
            </div>
            <div class="card-body" id="debt-details-container">
                <!-- æˆ‘éœ€è¦ä»˜ç»™åˆ«äººçš„é’± -->
                {% if debt_details.i_owe %}
                    <div class="mb-3">
                        <h6 class="text-danger mb-2">
                            <i class="bi bi-arrow-up-circle"></i> æˆ‘éœ€è¦ä»˜ç»™ï¼š
                        </h6>
                        {% for debt in debt_details.i_owe %}
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small">{{ debt.user }}</span>
                                <span class="badge bg-danger">Â¥{{ "%.2f"|format(debt.amount) }}</span>
                            </div>
                            <div class="small text-muted mb-2">
                                {{ debt.bills|join(', ') }}
                            </div>
                        {% endfor %}
                        <hr class="my-2">
                        <div class="d-flex justify-content-between">
                            <strong class="text-danger">æ€»è®¡åº”ä»˜ï¼š</strong>
                            <strong class="text-danger">Â¥{{ "%.2f"|format(debt_details.total_i_owe) }}</strong>
                        </div>
                    </div>
                {% endif %}

                <!-- åˆ«äººéœ€è¦ä»˜ç»™æˆ‘çš„é’± -->
                {% if debt_details.owe_me %}
                    <div class="mb-3">
                        <h6 class="text-success mb-2">
                            <i class="bi bi-arrow-down-circle"></i> éœ€è¦ä»˜ç»™æˆ‘ï¼š
                        </h6>
                        {% for debt in debt_details.owe_me %}
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small">{{ debt.user }}</span>
                                <span class="badge bg-success">Â¥{{ "%.2f"|format(debt.amount) }}</span>
                            </div>
                            <div class="small text-muted mb-2">
                                {{ debt.bills|join(', ') }}
                            </div>
                        {% endfor %}
                        <hr class="my-2">
                        <div class="d-flex justify-content-between">
                            <strong class="text-success">æ€»è®¡åº”æ”¶ï¼š</strong>
                            <strong class="text-success">Â¥{{ "%.2f"|format(debt_details.total_owe_me) }}</strong>
                        </div>
                    </div>
                {% endif %}


                <!-- ç©ºçŠ¶æ€ -->
                {% if not debt_details.i_owe and not debt_details.owe_me %}
                    <div class="text-center py-3">
                        <h4 class="text-muted">âœ…</h4>
                        <p class="text-muted mb-0">ç›®å‰æ²¡æœ‰æœªç»“ç®—çš„å€ºåŠ¡</p>
                        <small class="text-muted">æ‰€æœ‰è´¦å•éƒ½å·²ç»“æ¸…</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">å¿«é€Ÿç»Ÿè®¡</h6>
            </div>
            <div class="card-body">
                {% set unsettled_bills = bills|selectattr("is_settled", "equalto", false)|list %}
                {% set settled_bills = bills|selectattr("is_settled", "equalto", true)|list %}

                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-warning" id="stats-unsettled">{{ unsettled_bills|length }}</h4>
                            <small class="text-muted">æœªç»“ç®—</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success" id="stats-settled">{{ settled_bills|length }}</h4>
                        <small class="text-muted">å·²ç»“ç®—</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å‡­è¯æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="receiptModalLabel">
                    <i class="bi bi-file-earmark-text"></i> è´¦å•å‡­è¯
                </h5>
                <div class="ms-auto d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-light me-2" onclick="toggleFullscreen()">
                        <i class="bi bi-arrows-fullscreen" id="fullscreenIcon"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body">
                <!-- è´¦å•ä¿¡æ¯åŒºåŸŸ -->
                <div id="receiptInfo" class="mb-3">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>

                <!-- å¤šæ–‡ä»¶æ ‡ç­¾é¡µï¼ˆå½“æœ‰å¤šä¸ªæ–‡ä»¶æ—¶æ˜¾ç¤ºï¼‰ -->
                <ul class="nav nav-tabs mb-3" id="receiptTabs" style="display:none;">
                    <!-- åŠ¨æ€å¡«å……æ ‡ç­¾ -->
                </ul>

                <!-- å‡­è¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="receiptContent" class="receipt-container tab-content">
                    <!-- åŠ¨æ€å¡«å……å‡­è¯å†…å®¹ -->
                </div>

                <!-- åŠ è½½åŠ¨ç”» -->
                <div id="receiptLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½å‡­è¯...</p>
                </div>

                <!-- é”™è¯¯ä¿¡æ¯ -->
                <div id="receiptError" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> <span id="errorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <div id="downloadButtons" class="d-inline-block">
                    <!-- åŠ¨æ€ç”Ÿæˆä¸‹è½½æŒ‰é’® -->
                </div>
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.receipt-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    max-height: 70vh;
    overflow-y: auto;
}

.receipt-container img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.receipt-container embed,
.receipt-container iframe {
    width: 100%;
    min-height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

#receiptInfo {
    background: #f0f7ff;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #0d6efd;
}

/* æ¨¡æ€æ¡†ä¼˜åŒ– */
.modal-xl .modal-body {
    max-height: 80vh;
    overflow-y: auto;
}

@media (min-width: 1200px) {
    .modal-xl {
        max-width: 90%;
    }
}

/* å…¨å±æŒ‰é’®æ ·å¼ */
.btn-light {
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    transition: all 0.3s;
}

.btn-light:hover {
    background-color: white;
    transform: scale(1.1);
}

/* å…¨å±æ¨¡å¼ä¸‹çš„ä¼˜åŒ– */
.modal-fullscreen .modal-body {
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

.modal-fullscreen .receipt-container {
    max-height: calc(100vh - 200px);
}
</style>

<script>
// å®šä¹‰å…¨å±€çš„æŸ¥çœ‹å‡­è¯å‡½æ•°
function viewReceipt(billId) {
    console.log('æŸ¥çœ‹å‡­è¯ï¼šè´¦å•ID=' + billId);

    try {
        // è·å–æˆ–åˆ›å»ºæ¨¡æ€æ¡†å®ä¾‹ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
        const modalElement = document.getElementById('receiptModal');
        if (!modalElement) {
            console.error('æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
            alert('é¡µé¢åŠ è½½é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }

        const modal = bootstrap.Modal.getOrCreateInstance(modalElement);

        // æ£€æŸ¥å¹¶é‡ç½®æ˜¾ç¤ºçŠ¶æ€
        const loadingElement = document.getElementById('receiptLoading');
        const contentElement = document.getElementById('receiptContent');
        const errorElement = document.getElementById('receiptError');
        const infoElement = document.getElementById('receiptInfo');

        if (!loadingElement || !contentElement || !errorElement || !infoElement) {
            console.error('æ¨¡æ€æ¡†å†…éƒ¨å…ƒç´ ç¼ºå¤±', {
                loading: !!loadingElement,
                content: !!contentElement,
                error: !!errorElement,
                info: !!infoElement
            });
            alert('é¡µé¢å…ƒç´ åŠ è½½ä¸å®Œæ•´ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }

        // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
        loadingElement.style.display = 'block';
        contentElement.style.display = 'none';
        errorElement.style.display = 'none';
        infoElement.innerHTML = '';
        contentElement.innerHTML = '';

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.show();

        // å‘é€AJAXè¯·æ±‚è·å–å‡­è¯ä¿¡æ¯
        fetch(`/api/receipt/${billId}`, {
            method: 'GET',
            credentials: 'same-origin',  // åŒ…å«cookie
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        })
        .then(response => {
            console.log('APIå“åº”çŠ¶æ€ï¼š', response.status);

            // å¤„ç†é‡å®šå‘ï¼ˆæœªç™»å½•ï¼‰
            if (response.status === 302 || response.redirected) {
                throw new Error('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            }

            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `è¯·æ±‚å¤±è´¥ï¼š${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('è·å–å‡­è¯æ•°æ®æˆåŠŸï¼š', data);

            // éšè—åŠ è½½åŠ¨ç”»
            if (loadingElement) loadingElement.style.display = 'none';
            if (contentElement) contentElement.style.display = 'block';

            // æ˜¾ç¤ºè´¦å•ä¿¡æ¯
            if (infoElement) {
                infoElement.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>è´¦å•æè¿°ï¼š</strong>${data.description}
                    </div>
                    <div class="col-md-3">
                        <strong>é‡‘é¢ï¼š</strong>Â¥${data.amount.toFixed(2)}
                    </div>
                    <div class="col-md-3">
                        <strong>æ—¥æœŸï¼š</strong>${data.date}
                    </div>
                </div>
            `;
            }

            // å¤„ç†å¤šæ–‡ä»¶æ˜¾ç¤º
            const receipts = data.receipts || [];
            const tabsElement = document.getElementById('receiptTabs');
            const downloadButtonsContainer = document.getElementById('downloadButtons');

            // å¦‚æœæ²¡æœ‰æ–°æ ¼å¼çš„receiptsä½†æœ‰æ—§æ ¼å¼æ•°æ®ï¼Œæ„å»ºå…¼å®¹æ•°ç»„
            if (receipts.length === 0 && data.filepath) {
                receipts.push({
                    filename: data.filename,
                    filepath: data.filepath,
                    file_type: data.receipt_type
                });
            }

            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            tabsElement.innerHTML = '';
            contentElement.innerHTML = '';
            downloadButtonsContainer.innerHTML = '';

            if (receipts.length === 0) {
                contentElement.innerHTML = '<div class="alert alert-warning">è¯¥è´¦å•æ²¡æœ‰ä¸Šä¼ å‡­è¯</div>';
                return;
            }

            // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥æ˜¾ç¤ºï¼Œä¸éœ€è¦æ ‡ç­¾é¡µ
            if (receipts.length === 1) {
                tabsElement.style.display = 'none';
                const receipt = receipts[0];
                const staticUrl = `/${receipt.filepath}`;

                if (receipt.file_type === 'image') {
                    contentElement.innerHTML = `
                        <div class="text-center">
                            <img src="${staticUrl}" alt="è´¦å•å‡­è¯" class="img-fluid"
                                 onerror="this.onerror=null; this.src='/static/img/no-image.png'; this.alt='å‡­è¯åŠ è½½å¤±è´¥'">
                        </div>
                    `;
                } else if (receipt.file_type === 'pdf') {
                    contentElement.innerHTML = `
                        <embed src="${staticUrl}" type="application/pdf" width="100%" style="height: 70vh; min-height: 600px;">
                        <div class="mt-3 text-center text-muted">
                            <small>å¦‚æœPDFæ— æ³•æ˜¾ç¤ºï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½æŒ‰é’®æŸ¥çœ‹</small>
                        </div>
                    `;
                }

                // æ·»åŠ ä¸‹è½½æŒ‰é’®
                downloadButtonsContainer.innerHTML = `
                    <a href="${staticUrl}" class="btn btn-primary" download="${receipt.filename}">
                        <i class="bi bi-download"></i> ä¸‹è½½å‡­è¯
                    </a>
                    <a href="${staticUrl}" class="btn btn-info" target="_blank">
                        <i class="bi bi-box-arrow-up-right"></i> æ–°çª—å£æ‰“å¼€
                    </a>
                `;
            } else {
                // å¤šä¸ªæ–‡ä»¶ï¼Œæ˜¾ç¤ºæ ‡ç­¾é¡µ
                tabsElement.style.display = 'flex';

                receipts.forEach((receipt, index) => {
                    const isActive = index === 0;
                    const icon = receipt.file_type === 'pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸';

                    // åˆ›å»ºæ ‡ç­¾
                    const tabItem = document.createElement('li');
                    tabItem.className = 'nav-item';
                    tabItem.innerHTML = `
                        <button class="nav-link ${isActive ? 'active' : ''}"
                                id="receipt-tab-${index}"
                                data-bs-toggle="tab"
                                data-bs-target="#receipt-pane-${index}"
                                type="button">
                            ${icon} ${receipt.filename}
                        </button>
                    `;
                    tabsElement.appendChild(tabItem);

                    // åˆ›å»ºå†…å®¹é¢æ¿
                    const paneDiv = document.createElement('div');
                    paneDiv.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
                    paneDiv.id = `receipt-pane-${index}`;

                    const staticUrl = `/${receipt.filepath}`;

                    if (receipt.file_type === 'image') {
                        paneDiv.innerHTML = `
                            <div class="text-center">
                                <img src="${staticUrl}" alt="${receipt.filename}" class="img-fluid"
                                     onerror="this.onerror=null; this.src='/static/img/no-image.png'; this.alt='å‡­è¯åŠ è½½å¤±è´¥'">
                            </div>
                        `;
                    } else if (receipt.file_type === 'pdf') {
                        paneDiv.innerHTML = `
                            <embed src="${staticUrl}" type="application/pdf" width="100%" style="height: 70vh; min-height: 600px;">
                            <div class="mt-3 text-center text-muted">
                                <small>å¦‚æœPDFæ— æ³•æ˜¾ç¤ºï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½æŒ‰é’®æŸ¥çœ‹</small>
                            </div>
                        `;
                    }

                    contentElement.appendChild(paneDiv);
                });

                // æ·»åŠ æ‰¹é‡ä¸‹è½½æŒ‰é’®å’Œå•ç‹¬æŸ¥çœ‹é€‰é¡¹
                let buttonsHtml = '';
                if (receipts.length > 1) {
                    buttonsHtml += `
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-download"></i> ä¸‹è½½å‡­è¯
                            </button>
                            <ul class="dropdown-menu">
                    `;

                    receipts.forEach((receipt, index) => {
                        const staticUrl = `/${receipt.filepath}`;
                        const icon = receipt.file_type === 'pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸';
                        buttonsHtml += `
                            <li>
                                <a class="dropdown-item" href="${staticUrl}" download="${receipt.filename}">
                                    ${icon} ${receipt.filename}
                                </a>
                            </li>
                        `;
                    });

                    buttonsHtml += `
                            </ul>
                        </div>
                    `;
                } else {
                    const staticUrl = `/${receipts[0].filepath}`;
                    buttonsHtml = `
                        <a href="${staticUrl}" class="btn btn-primary" download="${receipts[0].filename}">
                            <i class="bi bi-download"></i> ä¸‹è½½å‡­è¯
                        </a>
                    `;
                }

                downloadButtonsContainer.innerHTML = buttonsHtml;
            }

            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            const fileCount = receipts.length > 1 ? ` (${receipts.length}ä¸ªæ–‡ä»¶)` : '';
            document.getElementById('receiptModalLabel').innerHTML = `
                <i class="bi bi-file-earmark-text"></i> è´¦å•å‡­è¯ - ${data.description}${fileCount}
            `;
        })
        .catch(error => {
            console.error('åŠ è½½å‡­è¯é”™è¯¯ï¼š', error);

            // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) {
                errorElement.style.display = 'block';
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'åŠ è½½å‡­è¯æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                }
            }

            // å¦‚æœæ˜¯ç™»å½•è¿‡æœŸï¼Œ3ç§’ååˆ·æ–°é¡µé¢
            if (error.message && error.message.includes('ç™»å½•')) {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        });

    } catch (error) {
        console.error('viewReceiptå‡½æ•°æ‰§è¡Œé”™è¯¯ï¼š', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

// å…¨å±åˆ‡æ¢åŠŸèƒ½
function toggleFullscreen() {
    const modalDialog = document.querySelector('#receiptModal .modal-dialog');
    const fullscreenIcon = document.getElementById('fullscreenIcon');

    if (modalDialog.classList.contains('modal-fullscreen')) {
        // é€€å‡ºå…¨å±
        modalDialog.classList.remove('modal-fullscreen');
        modalDialog.classList.add('modal-xl');
        fullscreenIcon.classList.remove('bi-arrows-angle-contract');
        fullscreenIcon.classList.add('bi-arrows-fullscreen');
    } else {
        // è¿›å…¥å…¨å±
        modalDialog.classList.remove('modal-xl');
        modalDialog.classList.add('modal-fullscreen');
        fullscreenIcon.classList.remove('bi-arrows-fullscreen');
        fullscreenIcon.classList.add('bi-arrows-angle-contract');
    }
}

// æ£€æŸ¥è´¦å•æ˜¯å¦å…¨éƒ¨ç»“ç®—
function checkAllSettled(billId) {
    // è·å–æ‰€æœ‰éä»˜æ¬¾äººçš„æŒ‰é’®
    const buttons = document.querySelectorAll(`button[id^="bill-${billId}-user-"][id$="-btn"]`);
    let allSettled = true;

    buttons.forEach(btn => {
        if (btn.classList.contains('btn-outline-success')) {
            allSettled = false;
        }
    });

    return allSettled;
}

// å•äººç»“ç®—åŠŸèƒ½ï¼ˆAJAXç‰ˆæœ¬ï¼‰
function settleIndividual(billId, userId, userName) {
    // è·å–æŒ‰é’®å…ƒç´ ä»¥åˆ¤æ–­å½“å‰çŠ¶æ€
    const btn = event.target.closest('button');
    const isCancel = btn.classList.contains('btn-outline-warning');

    const action = isCancel ? 'æ’¤é”€ç»“ç®—' : 'ç¡®è®¤ä»˜æ¬¾';
    const confirmMsg = isCancel ?
        `ç¡®è®¤æ’¤é”€${userName}çš„ç»“ç®—ï¼Ÿ` :
        `ç¡®è®¤${userName}å·²ä»˜æ¬¾ï¼Ÿ`;

    if (!confirm(confirmMsg)) {
        return false;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    btn.disabled = true;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch(`/settle_individual/${billId}/${userId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showToast(data.message, 'success');

            // æ›´æ–°UI
            updateSettlementUI(billId, userId, data.user_settled, data.settled_date);

            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar(billId);

            // å»¶è¿Ÿä¸€ä¸‹è®©DOMæ›´æ–°å®Œæˆï¼Œç„¶åæ›´æ–°çŠ¶æ€
            setTimeout(function() {
                // é‡æ–°è®¡ç®—çŠ¶æ€ï¼Œåªç»Ÿè®¡æœ‰æŒ‰é’®çš„å‚ä¸è€…ï¼ˆæ’é™¤ä»˜æ¬¾äººï¼‰
                const allButtons = document.querySelectorAll(`[id^="bill-${billId}-user-"][id$="-btn"]`);
                let settledCount = 0;
                let totalCount = 0;

                allButtons.forEach(function(buttonElement) {
                    totalCount++;
                    // è·å–å¯¹åº”çš„å›¾æ ‡å…ƒç´ 
                    const userId = buttonElement.id.match(/user-(\d+)-btn/)[1];
                    const iconElement = document.querySelector(`#bill-${billId}-user-${userId}-icon`);
                    if (iconElement && iconElement.querySelector('.bi-check-circle-fill.text-success')) {
                        settledCount++;
                    }
                });

                // åˆ¤æ–­çŠ¶æ€
                const isFullySettled = totalCount > 0 && settledCount === totalCount;
                const isPartiallySettled = settledCount > 0 && settledCount < totalCount;

                // æ›´æ–°å„ç§UIå…ƒç´ 
                updateBillStatusDirect(billId, isFullySettled, isPartiallySettled);
                updateBillCardBorder(billId, isFullySettled);
                updateSettlementButton(billId, isFullySettled);
                // æ›´æ–°å¿«é€Ÿç»Ÿè®¡å’Œå€ºåŠ¡å…³ç³»
                updateQuickStats();
                updateDebtDetails();
            }, 50);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥', 'danger');
            // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('ç»“ç®—æ“ä½œå¤±è´¥ï¼š', error);
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        // æ¢å¤æŒ‰é’®
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });

    return false; // é˜²æ­¢é»˜è®¤è¡Œä¸º
}

// æ•´ä½“ç»“ç®—åˆ‡æ¢åŠŸèƒ½ï¼ˆAJAXç‰ˆæœ¬ï¼‰
function toggleBillSettlement(billId, isCurrentlySettled) {
    const action = isCurrentlySettled ? 'æ ‡è®°ä¸ºæœªç»“ç®—' : 'æ ‡è®°ä¸ºå·²ç»“ç®—';
    const confirmMsg = isCurrentlySettled ?
        'ç¡®è®¤å…¨éƒ¨æ ‡è®°ä¸ºæœªç»“ç®—ï¼Ÿ' :
        'ç¡®è®¤å…¨éƒ¨æ ‡è®°ä¸ºå·²ç»“ç®—ï¼Ÿ';

    if (!confirm(confirmMsg)) {
        return false;
    }

    // è·å–æŒ‰é’®å…ƒç´ 
    const btn = event.target.closest('button');
    btn.disabled = true;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å¤„ç†ä¸­...';

    fetch(`/toggle_settlement/${billId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showToast(data.message, 'success');

            // æ›´æ–°æ‰€æœ‰å‚ä¸è€…çš„ç»“ç®—çŠ¶æ€
            if (data.settlement_status) {
                for (const [userId, status] of Object.entries(data.settlement_status)) {
                    updateSettlementUI(billId, parseInt(userId), status.is_settled, status.settled_date);
                }
            }

            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar(billId);

            // å»¶è¿Ÿä¸€ä¸‹è®©DOMæ›´æ–°å®Œæˆï¼Œç„¶åæ›´æ–°çŠ¶æ€
            setTimeout(function() {
                // é‡æ–°è®¡ç®—çŠ¶æ€ï¼Œåªç»Ÿè®¡æœ‰æŒ‰é’®çš„å‚ä¸è€…ï¼ˆæ’é™¤ä»˜æ¬¾äººï¼‰
                const allButtons = document.querySelectorAll(`[id^="bill-${billId}-user-"][id$="-btn"]`);
                let settledCount = 0;
                let totalCount = 0;

                allButtons.forEach(function(buttonElement) {
                    totalCount++;
                    // è·å–å¯¹åº”çš„å›¾æ ‡å…ƒç´ 
                    const userId = buttonElement.id.match(/user-(\d+)-btn/)[1];
                    const iconElement = document.querySelector(`#bill-${billId}-user-${userId}-icon`);
                    if (iconElement && iconElement.querySelector('.bi-check-circle-fill.text-success')) {
                        settledCount++;
                    }
                });

                // åˆ¤æ–­çŠ¶æ€
                const isFullySettled = totalCount > 0 && settledCount === totalCount;
                const isPartiallySettled = settledCount > 0 && settledCount < totalCount;

                // æ›´æ–°å„ç§UIå…ƒç´ 
                updateBillStatusDirect(billId, isFullySettled, isPartiallySettled);
                updateBillCardBorder(billId, isFullySettled);
                updateSettlementButton(billId, isFullySettled);
                // æ›´æ–°å¿«é€Ÿç»Ÿè®¡å’Œå€ºåŠ¡å…³ç³»
                updateQuickStats();
                updateDebtDetails();
            }, 50);
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥', 'danger');
            // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        console.error('ç»“ç®—æ“ä½œå¤±è´¥ï¼š', error);
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        // æ¢å¤æŒ‰é’®
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });

    return false;
}

// æ›´æ–°å•ä¸ªç”¨æˆ·çš„ç»“ç®—UI
function updateSettlementUI(billId, userId, isSettled, settledDate) {
    // æ›´æ–°å›¾æ ‡
    const iconElement = document.querySelector(`#bill-${billId}-user-${userId}-icon`);
    if (iconElement) {
        if (isSettled) {
            iconElement.innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>';
        } else {
            iconElement.innerHTML = '<i class="bi bi-clock text-warning me-1"></i>';
        }
    }

    // æ›´æ–°é‡‘é¢æ˜¾ç¤º
    const amountElement = document.querySelector(`#bill-${billId}-user-${userId}-amount`);
    if (amountElement) {
        const amountValue = amountElement.querySelector('small')?.textContent || '';
        if (isSettled) {
            amountElement.innerHTML = `<small class="text-success">${amountValue}</small>`;
        } else {
            amountElement.innerHTML = `<small class="text-danger">${amountValue}</small>`;
        }
    }

    // æ›´æ–°æŒ‰é’®
    const btnElement = document.querySelector(`#bill-${billId}-user-${userId}-btn`);
    if (btnElement) {
        btnElement.disabled = false;  // é‡æ–°å¯ç”¨æŒ‰é’®ï¼Œç¡®ä¿å¯ä»¥ç»§ç»­ç‚¹å‡»
        if (isSettled) {
            btnElement.className = 'btn btn-sm btn-outline-warning px-1 py-0 ms-1';
            btnElement.style.fontSize = '0.6rem';
            btnElement.innerHTML = 'æ’¤é”€';
        } else {
            btnElement.className = 'btn btn-sm btn-outline-success px-1 py-0 ms-1';
            btnElement.style.fontSize = '0.7rem';
            btnElement.innerHTML = 'âœ“';
        }
    }
}

// ç›´æ¥æ›´æ–°è´¦å•çŠ¶æ€ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
function updateBillStatusDirect(billId, isFullySettled, isPartiallySettled) {
    const statusBadge = document.querySelector(`#bill-${billId}-status`);
    if (!statusBadge) return;

    if (isFullySettled) {
        // å…¨éƒ¨ç»“ç®—
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'å…¨éƒ¨ç»“ç®—';
    } else if (isPartiallySettled) {
        // éƒ¨åˆ†ç»“ç®—
        statusBadge.className = 'badge bg-warning';
        statusBadge.textContent = 'éƒ¨åˆ†ç»“ç®—';
    } else {
        // æœªç»“ç®—
        statusBadge.className = 'badge bg-danger';
        statusBadge.textContent = 'æœªç»“ç®—';
    }
}

// æ›´æ–°è´¦å•æ•´ä½“çŠ¶æ€
function updateBillStatus(billId, isSettled) {
    const statusBadge = document.querySelector(`#bill-${billId}-status`);
    if (!statusBadge) return;

    // å¦‚æœä¼ å…¥å¸ƒå°”å€¼ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰ï¼Œè®¡ç®—å®é™…çŠ¶æ€
    if (typeof isSettled === 'boolean') {
        // è®¡ç®—å·²ç»“ç®—äººæ•°æ¥ç¡®å®šå…·ä½“çŠ¶æ€ï¼Œåªç»Ÿè®¡æœ‰æŒ‰é’®çš„å‚ä¸è€…ï¼ˆæ’é™¤ä»˜æ¬¾äººï¼‰
        const allButtons = document.querySelectorAll(`[id^="bill-${billId}-user-"][id$="-btn"]`);
        let settledCount = 0;
        let totalCount = 0;

        allButtons.forEach(function(buttonElement) {
            totalCount++;
            // è·å–å¯¹åº”çš„å›¾æ ‡å…ƒç´ 
            const userId = buttonElement.id.match(/user-(\d+)-btn/)[1];
            const iconElement = document.querySelector(`#bill-${billId}-user-${userId}-icon`);
            if (iconElement && iconElement.querySelector('.bi-check-circle-fill.text-success')) {
                settledCount++;
            }
        });

        // æ ¹æ®ç»“ç®—æƒ…å†µåˆ¤æ–­çŠ¶æ€
        if (isSettled && totalCount > 0) {
            // æ˜ç¡®æŒ‡å®šä¸ºå·²ç»“ç®—
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'å…¨éƒ¨ç»“ç®—';
        } else if (totalCount > 0 && settledCount === totalCount) {
            // å…¨éƒ¨ç»“ç®—ï¼ˆæ‰€æœ‰äººéƒ½å·²ç»“ç®—ï¼‰
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'å…¨éƒ¨ç»“ç®—';
        } else if (settledCount > 0 && settledCount < totalCount) {
            // éƒ¨åˆ†ç»“ç®—
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = 'éƒ¨åˆ†ç»“ç®—';
        } else {
            // æœªç»“ç®—ï¼ˆæ²¡æœ‰äººç»“ç®—æˆ–æ²¡æœ‰æ‰¾åˆ°å‚ä¸è€…ï¼‰
            statusBadge.className = 'badge bg-danger';
            statusBadge.textContent = 'æœªç»“ç®—';
        }
    }
}

// æ›´æ–°è´¦å•å¡ç‰‡è¾¹æ¡†é¢œè‰²
function updateBillCardBorder(billId, isSettled) {
    const card = document.querySelector(`#bill-${billId}-card`);
    if (!card) return;

    // ç§»é™¤æ‰€æœ‰è¾¹æ¡†ç±»
    card.classList.remove('border-warning', 'border-success', 'border-danger');

    // å¦‚æœä¼ å…¥å¸ƒå°”å€¼ï¼Œè®¡ç®—å®é™…çŠ¶æ€
    if (typeof isSettled === 'boolean') {
        // è®¡ç®—å·²ç»“ç®—äººæ•°æ¥ç¡®å®šå…·ä½“çŠ¶æ€ï¼Œåªç»Ÿè®¡æœ‰æŒ‰é’®çš„å‚ä¸è€…ï¼ˆæ’é™¤ä»˜æ¬¾äººï¼‰
        const allButtons = document.querySelectorAll(`[id^="bill-${billId}-user-"][id$="-btn"]`);
        let settledCount = 0;
        let totalCount = 0;

        allButtons.forEach(function(buttonElement) {
            totalCount++;
            // è·å–å¯¹åº”çš„å›¾æ ‡å…ƒç´ 
            const userId = buttonElement.id.match(/user-(\d+)-btn/)[1];
            const iconElement = document.querySelector(`#bill-${billId}-user-${userId}-icon`);
            if (iconElement && iconElement.querySelector('.bi-check-circle-fill.text-success')) {
                settledCount++;
            }
        });

        // æ ¹æ®ç»“ç®—æƒ…å†µè®¾ç½®è¾¹æ¡†é¢œè‰²
        if (isSettled && totalCount > 0) {
            // æ˜ç¡®æŒ‡å®šä¸ºå·²ç»“ç®— - ç»¿è‰²è¾¹æ¡†
            card.classList.add('border-success');
        } else if (totalCount > 0 && settledCount === totalCount) {
            // å…¨éƒ¨ç»“ç®— - ç»¿è‰²è¾¹æ¡†
            card.classList.add('border-success');
        } else {
            // éƒ¨åˆ†ç»“ç®—æˆ–æœªç»“ç®— - é»„è‰²è¾¹æ¡†
            card.classList.add('border-warning');
        }
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgressBar(billId) {
    // è®¡ç®—å·²ç»“ç®—äººæ•°ï¼Œåªç»Ÿè®¡æœ‰æŒ‰é’®çš„å‚ä¸è€…ï¼ˆæ’é™¤ä»˜æ¬¾äººï¼‰
    const allButtons = document.querySelectorAll(`[id^="bill-${billId}-user-"][id$="-btn"]`);
    let settledCount = 0;
    let totalCount = 0;

    // ä»˜æ¬¾äººå§‹ç»ˆç®—ä½œå·²ç»“ç®—
    let payerSettled = 1;

    allButtons.forEach(function(buttonElement) {
        totalCount++;
        // è·å–å¯¹åº”çš„å›¾æ ‡å…ƒç´ 
        const userId = buttonElement.id.match(/user-(\d+)-btn/)[1];
        const iconElement = document.querySelector(`#bill-${billId}-user-${userId}-icon`);
        if (iconElement && iconElement.querySelector('.bi-check-circle-fill.text-success')) {
            settledCount++;
        }
    });

    // æ€»äººæ•°åŒ…æ‹¬ä»˜æ¬¾äººï¼Œå·²ç»“ç®—äººæ•°åŒ…æ‹¬ä»˜æ¬¾äººå’Œå·²ç»“ç®—çš„å‚ä¸è€…
    const totalWithPayer = totalCount + 1;
    const settledWithPayer = settledCount + payerSettled;

    // è®¡ç®—ç™¾åˆ†æ¯”ï¼ˆåŒ…æ‹¬ä»˜æ¬¾äººï¼‰
    const percentage = totalWithPayer > 0 ? (settledWithPayer / totalWithPayer * 100) : 0;

    // æ›´æ–°è¿›åº¦æ–‡æœ¬
    const progressText = document.querySelector(`#bill-${billId}-progress-text`);
    if (progressText) {
        progressText.textContent = `${settledWithPayer}/${totalWithPayer}äºº`;
    }

    // æ›´æ–°è¿›åº¦æ¡
    const progressBar = document.querySelector(`#bill-${billId}-progress-bar`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }
}

// æ›´æ–°å¿«é€Ÿç»Ÿè®¡
function updateQuickStats() {
    // è®¡ç®—å·²ç»“ç®—å’Œæœªç»“ç®—çš„è´¦å•æ•°é‡
    const allCards = document.querySelectorAll('[id$="-card"]');
    let settledCount = 0;
    let unsettledCount = 0;

    allCards.forEach(function(card) {
        if (card.classList.contains('border-success')) {
            settledCount++;
        } else if (card.classList.contains('border-warning')) {
            unsettledCount++;
        }
    });

    // æ›´æ–°æ˜¾ç¤º
    const unsettledEl = document.getElementById('stats-unsettled');
    const settledEl = document.getElementById('stats-settled');

    if (unsettledEl) {
        unsettledEl.textContent = unsettledCount;
    }
    if (settledEl) {
        settledEl.textContent = settledCount;
    }
}

// æ›´æ–°å€ºåŠ¡å…³ç³»
function updateDebtDetails() {
    fetch('/api/debt_details', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('debt-details-container');
        if (!container) return;

        let html = '';

        // æˆ‘éœ€è¦ä»˜ç»™åˆ«äººçš„é’±
        if (data.i_owe && data.i_owe.length > 0) {
            html += `
                <div class="mb-3">
                    <h6 class="text-danger mb-2">
                        <i class="bi bi-arrow-up-circle"></i> æˆ‘éœ€è¦ä»˜ç»™ï¼š
                    </h6>`;

            data.i_owe.forEach(function(debt) {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">${debt.user}</span>
                        <span class="badge bg-danger">Â¥${debt.amount.toFixed(2)}</span>
                    </div>
                    <div class="small text-muted mb-2">
                        ${debt.bills.join(', ')}
                    </div>`;
            });

            html += `
                    <hr class="my-2">
                    <div class="d-flex justify-content-between">
                        <strong class="text-danger">æ€»è®¡åº”ä»˜ï¼š</strong>
                        <strong class="text-danger">Â¥${data.total_i_owe.toFixed(2)}</strong>
                    </div>
                </div>`;
        }

        // åˆ«äººéœ€è¦ä»˜ç»™æˆ‘çš„é’±
        if (data.owe_me && data.owe_me.length > 0) {
            html += `
                <div class="mb-3">
                    <h6 class="text-success mb-2">
                        <i class="bi bi-arrow-down-circle"></i> éœ€è¦ä»˜ç»™æˆ‘ï¼š
                    </h6>`;

            data.owe_me.forEach(function(debt) {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">${debt.user}</span>
                        <span class="badge bg-success">Â¥${debt.amount.toFixed(2)}</span>
                    </div>
                    <div class="small text-muted mb-2">
                        ${debt.bills.join(', ')}
                    </div>`;
            });

            html += `
                    <hr class="my-2">
                    <div class="d-flex justify-content-between">
                        <strong class="text-success">æ€»è®¡åº”æ”¶ï¼š</strong>
                        <strong class="text-success">Â¥${data.total_owe_me.toFixed(2)}</strong>
                    </div>
                </div>`;
        }

        // ç©ºçŠ¶æ€
        if ((!data.i_owe || data.i_owe.length === 0) && (!data.owe_me || data.owe_me.length === 0)) {
            html = `
                <div class="text-center py-3">
                    <h4 class="text-muted">âœ…</h4>
                    <p class="text-muted mb-0">ç›®å‰æ²¡æœ‰æœªç»“ç®—çš„å€ºåŠ¡</p>
                    <small class="text-muted">æ‰€æœ‰è´¦å•éƒ½å·²ç»“æ¸…</small>
                </div>`;
        }

        container.innerHTML = html;
    })
    .catch(error => {
        console.error('æ›´æ–°å€ºåŠ¡å…³ç³»å¤±è´¥ï¼š', error);
    });
}

// æ›´æ–°æ•´ä½“ç»“ç®—æŒ‰é’®
function updateSettlementButton(billId, isSettled) {
    const btnElement = document.querySelector(`#bill-${billId}-toggle-btn`);
    if (!btnElement) return;

    if (isSettled) {
        btnElement.className = 'btn btn-sm btn-outline-warning me-1';
        btnElement.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> å…¨éƒ¨æ’¤é”€';
        btnElement.setAttribute('onclick', `return toggleBillSettlement(${billId}, true)`);
    } else {
        btnElement.className = 'btn btn-sm btn-success me-1';
        btnElement.innerHTML = '<i class="bi bi-check-all"></i> å…¨éƒ¨ç»“ç®—';
        btnElement.setAttribute('onclick', `return toggleBillSettlement(${billId}, false)`);
    }
    btnElement.disabled = false;
}

// é¡µé¢åŠ è½½å®Œæˆåï¼Œç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶æ¸…ç†
document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('receiptModal');
    if (modalElement) {
        modalElement.addEventListener('hidden.bs.modal', function() {
            console.log('æ¨¡æ€æ¡†å·²å…³é—­ï¼Œæ¸…ç†å†…å®¹');
            // æ¸…ç†æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('receiptInfo').innerHTML = '';
            document.getElementById('receiptContent').innerHTML = '';
            document.getElementById('receiptError').style.display = 'none';

            // é‡ç½®ä¸ºéå…¨å±çŠ¶æ€
            const modalDialog = document.querySelector('#receiptModal .modal-dialog');
            if (modalDialog.classList.contains('modal-fullscreen')) {
                modalDialog.classList.remove('modal-fullscreen');
                modalDialog.classList.add('modal-xl');
                document.getElementById('fullscreenIcon').classList.remove('bi-arrows-angle-contract');
                document.getElementById('fullscreenIcon').classList.add('bi-arrows-fullscreen');
            }
        });
    }
});
</script>
{% endblock %}