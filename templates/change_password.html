{% extends "base.html" %}

{% block title %}修改密码 - 室友记账系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-key"></i> 修改密码
                </h5>
            </div>
            <div class="card-body">
                <!-- 密码要求提示 -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>密码要求：</strong>
                    <ul class="mb-0 mt-2">
                        <li>至少8个字符</li>
                        <li>必须包含字母</li>
                        <li>必须包含数字</li>
                    </ul>
                </div>

                <!-- 错误消息 -->
                {% with messages = get_flashed_messages(category_filter=['error']) %}
                    {% if messages %}
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            {% for message in messages %}
                                <div>{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form method="POST" id="changePasswordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">
                            <i class="bi bi-lock"></i> 当前密码
                        </label>
                        <input type="password" class="form-control" id="current_password"
                               name="current_password" required>
                    </div>

                    <div class="mb-3">
                        <label for="new_password" class="form-label">
                            <i class="bi bi-key"></i> 新密码
                        </label>
                        <input type="password" class="form-control" id="new_password"
                               name="new_password" required
                               minlength="8">
                        <div class="form-text">请输入符合要求的新密码</div>
                    </div>

                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="bi bi-check-circle"></i> 确认新密码
                        </label>
                        <input type="password" class="form-control" id="confirm_password"
                               name="confirm_password" required
                               minlength="8">
                        <div class="form-text">请再次输入新密码</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> 修改密码
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 返回首页
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 密码确认验证
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('两次输入的新密码不一致，请重新输入');
        document.getElementById('confirm_password').focus();
        return false;
    }

    // 密码强度检查
    if (newPassword.length < 8) {
        e.preventDefault();
        alert('密码至少需要8个字符');
        document.getElementById('new_password').focus();
        return false;
    }

    if (!/[a-zA-Z]/.test(newPassword)) {
        e.preventDefault();
        alert('密码必须包含字母');
        document.getElementById('new_password').focus();
        return false;
    }

    if (!/\d/.test(newPassword)) {
        e.preventDefault();
        alert('密码必须包含数字');
        document.getElementById('new_password').focus();
        return false;
    }
});

// 实时密码确认检查
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;

    if (confirmPassword && newPassword !== confirmPassword) {
        this.setCustomValidity('密码不一致');
        this.classList.add('is-invalid');
    } else {
        this.setCustomValidity('');
        this.classList.remove('is-invalid');
        if (confirmPassword) {
            this.classList.add('is-valid');
        }
    }
});
</script>
{% endblock %}