{% extends "base.html" %}

{% block title %}æ·»åŠ è´¦å• - å®¤å‹è®°è´¦ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">æ·»åŠ æ–°è´¦å•</h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <!-- è´¦å•ç±»å‹é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è´¦å•ç±»å‹</label>
                        <div class="row g-2">
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="water" id="type_water" required>
                                <label class="btn btn-outline-primary w-100" for="type_water">
                                    ğŸ’§ æ°´è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="electricity" id="type_electricity">
                                <label class="btn btn-outline-primary w-100" for="type_electricity">
                                    âš¡ ç”µè´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="gas" id="type_gas">
                                <label class="btn btn-outline-primary w-100" for="type_gas">
                                    ğŸ”¥ ç‡ƒæ°”è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="trash" id="type_trash">
                                <label class="btn btn-outline-primary w-100" for="type_trash">
                                    ğŸ—‘ï¸ åƒåœ¾è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="internet" id="type_internet">
                                <label class="btn btn-outline-primary w-100" for="type_internet">
                                    ğŸŒ ç½‘è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="shopping" id="type_shopping">
                                <label class="btn btn-outline-primary w-100" for="type_shopping">
                                    ğŸ›’ è¶…å¸‚è´­ä¹°
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="food" id="type_food">
                                <label class="btn btn-outline-primary w-100" for="type_food">
                                    ğŸ” é¤é¥®å¤–å–
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="daily" id="type_daily">
                                <label class="btn btn-outline-primary w-100" for="type_daily">
                                    ğŸ§» æ—¥ç”¨å“
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="other" id="type_other">
                                <label class="btn btn-outline-primary w-100" for="type_other">
                                    ğŸ“ å…¶å®ƒ
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰æè¿°è¾“å…¥ï¼ˆé€‰æ‹©"å…¶å®ƒ"æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div class="mb-3" id="custom_description_div" style="display:none;">
                        <label for="custom_description" class="form-label">è¯·è¾“å…¥å…·ä½“æè¿°</label>
                        <input type="text" class="form-control" id="custom_description" name="custom_description"
                               placeholder="è¯·æè¿°å…·ä½“çš„è´¹ç”¨ç±»å‹">
                    </div>

                    <!-- è´¦å•æ—¥æœŸé€‰æ‹© -->
                    <div class="mb-3">
                        <label for="bill_date" class="form-label">è´¦å•æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="bill_date" name="bill_date"
                               value="{{ today }}" required>
                        <small class="form-text text-muted">é€‰æ‹©è¯¥è´¦å•çš„å®é™…æ—¥æœŸ</small>
                    </div>

                    <!-- è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰ -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-control" id="notes" name="notes"
                               placeholder="å¦‚ï¼šåŒ…å«æ»çº³é‡‘ã€ç‰¹åˆ«è¯´æ˜ç­‰">
                    </div>

                    <div class="mb-3">
                        <label for="amount" class="form-label">é‡‘é¢ (Â¥)</label>
                        <input type="number" class="form-control" id="amount" name="amount"
                               step="0.01" min="0" placeholder="0.00" required>
                    </div>

                    <!-- è´¦å•å‡­è¯ä¸Šä¼ ï¼ˆæ”¯æŒå¤šæ–‡ä»¶æ‹–æ‹½ï¼‰ -->
                    <div class="mb-3">
                        <label class="form-label">
                            è´¦å•å‡­è¯ï¼ˆå¯é€‰ï¼‰
                            <small class="text-muted">æ”¯æŒå›¾ç‰‡(JPG/PNG/GIF)å’ŒPDFï¼Œæ¯ä¸ªæ–‡ä»¶æœ€å¤§10MBï¼Œå¯ä¸Šä¼ å¤šä¸ª</small>
                        </label>

                        <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                        <div id="drop-zone" class="border-2 border-dashed border-secondary rounded p-4 text-center position-relative"
                             style="background-color: #f8f9fa; cursor: pointer; min-height: 150px;">
                            <input type="file" id="receipt" name="receipts" multiple
                                   accept=".jpg,.jpeg,.png,.gif,.pdf" style="display: none;">

                            <div id="drop-zone-content">
                                <i class="bi bi-cloud-upload fs-1 text-secondary"></i>
                                <p class="mt-2 mb-1">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </p>
                                <p class="text-muted small mb-2">æˆ–è€…</p>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="browse-btn">
                                    é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>

                            <!-- æ‹–æ‹½æ—¶çš„æç¤º -->
                            <div id="drop-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-none"
                                 style="background-color: rgba(13, 110, 253, 0.1); border: 2px dashed #0d6efd; z-index: 10;">
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <div class="text-primary">
                                        <i class="bi bi-download fs-1"></i>
                                        <p class="mt-2 mb-0 fw-bold">é‡Šæ”¾ä»¥ä¸Šä¼ æ–‡ä»¶</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ–‡ä»¶åˆ—è¡¨ -->
                        <div id="file-list" class="mt-3" style="display: none;">
                            <h6 class="mb-2">å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</h6>
                            <div id="selected-files" class="list-group"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©éœ€è¦å‘ä½ ä»˜æ¬¾çš„äºº</label>
                        <div class="alert alert-info alert-dismissible fade show">
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
                            <small>ä½ å·²å«ä»˜å…¨æ¬¾ï¼Œè¯·é€‰æ‹©éœ€è¦ä¸ä½ ä¸€èµ·åˆ†æ‘Šè´¹ç”¨çš„å®¤å‹</small>
                        </div>

                        <!-- æ˜¾ç¤ºä»˜æ¬¾äººä¿¡æ¯ -->
                        <div class="alert alert-success mb-3 alert-dismissible fade show">
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-check me-2"></i>
                                <strong>{{ current_user.display_name }} (æˆ‘)</strong>
                                <span class="badge bg-success ms-2">ä»˜æ¬¾äºº</span>
                            </div>
                            <small class="text-muted">ä½ å·²å«ä»˜å…¨æ¬¾ï¼Œè‡ªåŠ¨å‚ä¸åˆ†æ‘Š</small>
                        </div>

                        <!-- å…¶ä»–å®¤å‹é€‰æ‹© -->
                        <div class="row g-3">
                            {% for user in users %}
                                {% if user.id != current_user.id %}
                                    <div class="col-md-6 col-lg-4">
                                        <!-- éšè—çš„checkboxï¼Œä¿æŒåŸæœ‰è¡¨å•é€»è¾‘ -->
                                        <input class="form-check-input participant-checkbox d-none" type="checkbox"
                                               name="participants" value="{{ user.id }}" id="user{{ user.id }}">

                                        <!-- å¯ç‚¹å‡»çš„å¡ç‰‡ -->
                                        <div class="participant-card card h-100 border-2 cursor-pointer user-select-none"
                                             data-user-id="{{ user.id }}"
                                             onclick="toggleParticipant({{ user.id }})">
                                            <div class="card-body text-center p-3">
                                                <div class="participant-avatar mb-2">
                                                    <i class="bi bi-person-circle fs-1 text-muted"></i>
                                                </div>
                                                <h6 class="card-title mb-2">{{ user.display_name }}</h6>
                                                <div class="selection-indicator">
                                                    <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                                                    <small class="text-muted selection-text">ç‚¹å‡»é€‰æ‹©</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- å®æ—¶è®¡ç®—æ˜¾ç¤º -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">åˆ†æ‘Šè®¡ç®—</h6>
                                <div id="split-calculation">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="text-muted small">æ€»é‡‘é¢</div>
                                            <div class="fw-bold" id="total-amount">Â¥0.00</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-muted small">åˆ†æ‘Šäººæ•°</div>
                                            <div class="fw-bold" id="participant-count">1äºº</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-muted small">æ¯äººåº”ä»˜</div>
                                            <div class="fw-bold text-primary" id="per-person-amount">Â¥0.00</div>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="text-center">
                                        <small class="text-muted">å…¶ä»–äººéœ€è¦ç»™ä½ ï¼š</small>
                                        <strong class="text-success" id="others-owe-me">Â¥0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">å–æ¶ˆ</a>
                        </div>
                        <div class="col-6">
                            <button type="submit" class="btn btn-primary w-100">æ·»åŠ è´¦å•</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// è´¦å•ç±»å‹é€‰æ‹©é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    // ç›‘å¬è´¦å•ç±»å‹é€‰æ‹©
    const billTypeRadios = document.querySelectorAll('input[name="bill_type"]');
    const customDescDiv = document.getElementById('custom_description_div');
    const customDescInput = document.getElementById('custom_description');

    billTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'other') {
                customDescDiv.style.display = 'block';
                customDescInput.required = true;
            } else {
                customDescDiv.style.display = 'none';
                customDescInput.required = false;
                customDescInput.value = '';
            }
        });
    });

    // å¤šæ–‡ä»¶æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const dropZone = document.getElementById('drop-zone');
    const dropOverlay = document.getElementById('drop-overlay');
    const fileInput = document.getElementById('receipt');
    const browseBtn = document.getElementById('browse-btn');
    const fileList = document.getElementById('file-list');
    const selectedFilesContainer = document.getElementById('selected-files');

    let selectedFiles = new Map(); // ä½¿ç”¨Mapå­˜å‚¨é€‰æ‹©çš„æ–‡ä»¶

    // ç‚¹å‡»æµè§ˆæŒ‰é’®æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
    browseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });

    // ç‚¹å‡»æ‹–æ‹½åŒºåŸŸä¹Ÿå¯ä»¥æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
    dropZone.addEventListener('click', function(e) {
        if (e.target === browseBtn || browseBtn.contains(e.target)) {
            return;
        }
        fileInput.click();
    });

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', function(e) {
        handleFiles(Array.from(e.target.files));
    });

    // æ‹–æ‹½äº‹ä»¶å¤„ç†
    dropZone.addEventListener('dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropOverlay.classList.remove('d-none');
    });

    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (e.target === dropZone || !dropZone.contains(e.relatedTarget)) {
            dropOverlay.classList.add('d-none');
        }
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropOverlay.classList.add('d-none');

        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
    function handleFiles(files) {
        let hasError = false;

        files.forEach(file => {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`);
                hasError = true;
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert(`æ–‡ä»¶å¤§å°è¶…è¿‡10MB: ${file.name}`);
                hasError = true;
                return;
            }

            // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºé”®å­˜å‚¨æ–‡ä»¶
            selectedFiles.set(file.name, file);
        });

        if (!hasError) {
            updateFileList();
        }

        // æ¸…ç©ºinputï¼Œä»¥ä¾¿å¯ä»¥é‡æ–°é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
        fileInput.value = '';
    }

    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
    function updateFileList() {
        if (selectedFiles.size === 0) {
            fileList.style.display = 'none';
            selectedFilesContainer.innerHTML = '';
            return;
        }

        fileList.style.display = 'block';
        selectedFilesContainer.innerHTML = '';

        selectedFiles.forEach((file, fileName) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';

            // æ–‡ä»¶å›¾æ ‡
            const icon = file.type === 'application/pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸';
            const fileSize = (file.size / 1024).toFixed(1);
            const sizeUnit = fileSize > 1024 ? `${(fileSize / 1024).toFixed(1)} MB` : `${fileSize} KB`;

            fileItem.innerHTML = `
                <div class="d-flex align-items-center flex-grow-1">
                    <span class="me-2">${icon}</span>
                    <div>
                        <div class="fw-medium">${fileName}</div>
                        <small class="text-muted">${sizeUnit}</small>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" data-filename="${fileName}">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;

            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            const removeBtn = fileItem.querySelector('button');
            removeBtn.addEventListener('click', function() {
                selectedFiles.delete(fileName);
                updateFileList();
            });

            selectedFilesContainer.appendChild(fileItem);

            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ·»åŠ é¢„è§ˆ
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'img-thumbnail mt-2';
                    preview.style.maxHeight = '100px';
                    preview.style.maxWidth = '100px';
                    fileItem.querySelector('div').appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // ä¿®æ”¹è¡¨å•æäº¤ï¼Œå°†é€‰æ‹©çš„æ–‡ä»¶æ·»åŠ åˆ°FormData
    const form = document.querySelector('form');
    const originalSubmit = form.onsubmit;
    form.onsubmit = function(e) {
        // å¦‚æœæœ‰é€‰æ‹©æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°æ„å»ºFormData
        if (selectedFiles.size > 0) {
            e.preventDefault();

            const formData = new FormData(form);
            // ç§»é™¤åŸå§‹çš„file input
            formData.delete('receipts');

            // æ·»åŠ æ‰€æœ‰é€‰æ‹©çš„æ–‡ä»¶
            selectedFiles.forEach((file) => {
                formData.append('receipts', file);
            });

            // ä½¿ç”¨fetchæäº¤è¡¨å•
            fetch(form.action || window.location.href, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    // æˆåŠŸåè·³è½¬åˆ°é¦–é¡µ
                    window.location.href = "{{ url_for('index') }}";
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                alert('æäº¤å¤±è´¥: ' + error.message);
            });

            return false;
        }

        // å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œæ­£å¸¸æäº¤
        return originalSubmit ? originalSubmit.call(this, e) : true;
    }

    // å®æ—¶è®¡ç®—åˆ†æ‘Šé‡‘é¢
    const amountInput = document.getElementById('amount');
    const checkboxes = document.querySelectorAll('.participant-checkbox');

    // æ˜¾ç¤ºå…ƒç´ 
    const totalAmountEl = document.getElementById('total-amount');
    const participantCountEl = document.getElementById('participant-count');
    const perPersonAmountEl = document.getElementById('per-person-amount');
    const othersOweMeEl = document.getElementById('others-owe-me');

    function updateSplitCalculation() {
        const amount = parseFloat(amountInput.value) || 0;
        const checkedCount = document.querySelectorAll('.participant-checkbox:checked').length;

        // æ€»äººæ•° = é€‰ä¸­çš„å…¶ä»–äºº + ä»˜æ¬¾äººè‡ªå·±
        const totalParticipants = checkedCount + 1;

        // è®¡ç®—æ¯äººåº”ä»˜é‡‘é¢
        const perPersonAmount = totalParticipants > 0 ? (amount / totalParticipants) : 0;

        // å…¶ä»–äººéœ€è¦ç»™ä»˜æ¬¾äººçš„æ€»é‡‘é¢
        const othersTotal = perPersonAmount * checkedCount;

        // æ›´æ–°æ˜¾ç¤º
        totalAmountEl.textContent = `Â¥${amount.toFixed(2)}`;
        participantCountEl.textContent = `${totalParticipants}äºº`;
        perPersonAmountEl.textContent = `Â¥${perPersonAmount.toFixed(2)}`;
        othersOweMeEl.textContent = `Â¥${othersTotal.toFixed(2)}`;

        // æ ¹æ®é‡‘é¢å’Œå‚ä¸äººæ•°æ·»åŠ è§†è§‰åé¦ˆ
        if (amount > 0 && checkedCount > 0) {
            perPersonAmountEl.className = 'fw-bold text-primary';
            othersOweMeEl.className = 'text-success fw-bold';
        } else if (amount > 0 && checkedCount === 0) {
            perPersonAmountEl.className = 'fw-bold text-warning';
            othersOweMeEl.className = 'text-muted';
        } else {
            perPersonAmountEl.className = 'fw-bold text-muted';
            othersOweMeEl.className = 'text-muted';
        }
    }

    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    amountInput.addEventListener('input', updateSplitCalculation);
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSplitCalculation);
    });

    // åˆå§‹è®¡ç®—
    updateSplitCalculation();
});

// åˆ‡æ¢å‚ä¸è€…é€‰æ‹©çŠ¶æ€
function toggleParticipant(userId) {
    const checkbox = document.getElementById(`user${userId}`);
    const card = document.querySelector(`[data-user-id="${userId}"]`);
    const checkIcon = card.querySelector('.bi-check-circle-fill');
    const selectionText = card.querySelector('.selection-text');
    const avatar = card.querySelector('.bi-person-circle');

    // åˆ‡æ¢checkboxçŠ¶æ€
    checkbox.checked = !checkbox.checked;

    // æ›´æ–°å¡ç‰‡æ ·å¼
    if (checkbox.checked) {
        // é€‰ä¸­çŠ¶æ€
        card.classList.add('border-success', 'bg-light');
        card.classList.remove('border-secondary');
        checkIcon.style.display = 'inline-block';
        selectionText.textContent = 'å·²é€‰æ‹©';
        selectionText.classList.remove('text-muted');
        selectionText.classList.add('text-success');
        avatar.classList.remove('text-muted');
        avatar.classList.add('text-success');

        // æ·»åŠ é€‰ä¸­åŠ¨ç”»
        card.style.transform = 'scale(0.98)';
        setTimeout(() => {
            card.style.transform = 'scale(1)';
        }, 150);
    } else {
        // æœªé€‰ä¸­çŠ¶æ€
        card.classList.remove('border-success', 'bg-light');
        card.classList.add('border-secondary');
        checkIcon.style.display = 'none';
        selectionText.textContent = 'ç‚¹å‡»é€‰æ‹©';
        selectionText.classList.add('text-muted');
        selectionText.classList.remove('text-success');
        avatar.classList.add('text-muted');
        avatar.classList.remove('text-success');
    }

    // è§¦å‘åˆ†æ‘Šè®¡ç®—æ›´æ–°
    const event = new Event('change');
    checkbox.dispatchEvent(event);
}
</script>
{% endblock %}