{% extends "base.html" %}

{% block title %}ç¼–è¾‘è´¦å• - å®¤å‹è®°è´¦ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">ç¼–è¾‘è´¦å•</h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <!-- è´¦å•ç±»å‹é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è´¦å•ç±»å‹</label>
                        <div class="row g-2">
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="water" id="type_water"
                                       {% if 'water' in bill.description.lower() or 'æ°´è´¹' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_water">
                                    ğŸ’§ æ°´è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="electricity" id="type_electricity"
                                       {% if 'electricity' in bill.description.lower() or 'ç”µè´¹' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_electricity">
                                    âš¡ ç”µè´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="gas" id="type_gas"
                                       {% if 'gas' in bill.description.lower() or 'ç‡ƒæ°”è´¹' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_gas">
                                    ğŸ”¥ ç‡ƒæ°”è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="trash" id="type_trash"
                                       {% if 'trash' in bill.description.lower() or 'åƒåœ¾è´¹' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_trash">
                                    ğŸ—‘ï¸ åƒåœ¾è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="internet" id="type_internet"
                                       {% if 'internet' in bill.description.lower() or 'ç½‘è´¹' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_internet">
                                    ğŸŒ ç½‘è´¹
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="shopping" id="type_shopping"
                                       {% if 'shopping' in bill.description.lower() or 'è´­ç‰©' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_shopping">
                                    ğŸ›’ è´­ç‰©
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="food" id="type_food"
                                       {% if 'food' in bill.description.lower() or 'é¤é¥®' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_food">
                                    ğŸ• é¤é¥®
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="transportation" id="type_transportation"
                                       {% if 'transportation' in bill.description.lower() or 'äº¤é€š' in bill.description %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_transportation">
                                    ğŸš— äº¤é€š
                                </label>
                            </div>
                            <div class="col-md-4 col-6">
                                <input type="radio" class="btn-check" name="bill_type" value="other" id="type_other"
                                       {% if not (('water' in bill.description.lower() or 'æ°´è´¹' in bill.description) or
                                                 ('electricity' in bill.description.lower() or 'ç”µè´¹' in bill.description) or
                                                 ('gas' in bill.description.lower() or 'ç‡ƒæ°”è´¹' in bill.description) or
                                                 ('trash' in bill.description.lower() or 'åƒåœ¾è´¹' in bill.description) or
                                                 ('internet' in bill.description.lower() or 'ç½‘è´¹' in bill.description) or
                                                 ('shopping' in bill.description.lower() or 'è´­ç‰©' in bill.description) or
                                                 ('food' in bill.description.lower() or 'é¤é¥®' in bill.description) or
                                                 ('transportation' in bill.description.lower() or 'äº¤é€š' in bill.description)) %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100" for="type_other">
                                    ğŸ“ å…¶å®ƒ
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰æè¿°è¾“å…¥æ¡† -->
                    <div class="mb-3" id="customDescriptionDiv">
                        <label for="description" class="form-label">è´¦å•æè¿°</label>
                        <input type="text" class="form-control" id="description" name="description"
                               placeholder="è¯·è¾“å…¥è´¦å•æè¿°" value="{{ bill.description }}" required>
                    </div>

                    <!-- è´¦å•é‡‘é¢ -->
                    <div class="mb-3">
                        <label for="amount" class="form-label">è´¦å•é‡‘é¢ (å…ƒ)</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount"
                               placeholder="0.00" value="{{ '%.2f'|format(bill.amount) }}" required>
                    </div>

                    <!-- è´¦å•æ—¥æœŸ -->
                    <div class="mb-3">
                        <label for="date" class="form-label">è´¦å•æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="date" name="date"
                               value="{{ bill.date.strftime('%Y-%m-%d') }}" required>
                    </div>

                    <!-- å‚ä¸è€…é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å‚ä¸è€…</label>
                        <div class="row g-3">
                            {% set current_participants = bill.get_participants_list() %}
                            {% for user in users %}
                            <div class="col-md-6 col-lg-4">
                                <!-- éšè—çš„checkboxï¼Œä¿æŒåŸæœ‰è¡¨å•é€»è¾‘ -->
                                <input class="form-check-input participant-checkbox d-none" type="checkbox"
                                       name="participants" value="{{ user.id }}" id="user_{{ user.id }}"
                                       data-username="{{ user.display_name }}"
                                       {% if user.id in current_participants %}checked{% endif %}>

                                <!-- å¯ç‚¹å‡»çš„å¡ç‰‡ -->
                                <div class="participant-card card h-100 border-2 cursor-pointer user-select-none
                                            {% if user.id in current_participants %}border-success bg-light{% else %}border-secondary{% endif %}"
                                     data-user-id="{{ user.id }}"
                                     onclick="toggleParticipantEdit({{ user.id }})">
                                    <div class="card-body text-center p-3">
                                        <div class="participant-avatar mb-2">
                                            <i class="bi bi-person-circle fs-1 {% if user.id in current_participants %}text-success{% else %}text-muted{% endif %}"></i>
                                        </div>
                                        <h6 class="card-title mb-2">
                                            {{ user.display_name }}
                                            {% if user.id == bill.payer_id %}
                                                <br><span class="badge bg-primary mt-1">ä»˜æ¬¾äºº</span>
                                            {% endif %}
                                        </h6>
                                        <div class="selection-indicator">
                                            <i class="bi bi-check-circle-fill text-success"
                                               style="display: {% if user.id in current_participants %}inline-block{% else %}none{% endif %};"></i>
                                            <small class="selection-text
                                                          {% if user.id in current_participants %}text-success{% else %}text-muted{% endif %}">
                                                {% if user.id in current_participants %}å·²é€‰æ‹©{% else %}ç‚¹å‡»é€‰æ‹©{% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">æ³¨æ„ï¼šä»˜æ¬¾äººä¼šè‡ªåŠ¨åŒ…å«åœ¨å‚ä¸è€…ä¸­</small>
                    </div>

                    <!-- ç°æœ‰å‡­è¯æ–‡ä»¶ -->
                    {% if bill.receipts %}
                    <div class="mb-3">
                        <label class="form-label">ç°æœ‰å‡­è¯æ–‡ä»¶</label>
                        <div class="row g-2" id="existingReceipts">
                            {% for receipt in bill.receipts %}
                            <div class="col-md-6" id="receipt-{{ receipt.id }}">
                                <div class="card border-info">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">{{ receipt.filename }}</small><br>
                                                <small class="text-muted">{{ (receipt.file_size / 1024) | round(1) }} KB</small>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-danger"
                                                        onclick="deleteExistingReceipt({{ receipt.id }}, '{{ receipt.filename }}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- æ–°å‡­è¯æ–‡ä»¶ä¸Šä¼  -->
                    <div class="mb-3">
                        <label for="receipts" class="form-label">ä¸Šä¼ æ–°å‡­è¯æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-content">
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="mb-2">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                                <p class="small text-muted">æ”¯æŒå›¾ç‰‡ (JPG, PNG, GIF) å’Œ PDF æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 10MB</p>
                                <input type="file" class="form-control d-none" id="receipts" name="receipts"
                                       multiple accept=".jpg,.jpeg,.png,.gif,.pdf">
                            </div>
                        </div>

                        <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                        <div class="mt-3" id="filePreviewArea" style="display: none;">
                            <label class="form-label">å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</label>
                            <div id="fileList" class="row g-2"></div>
                        </div>
                    </div>

                    <!-- è´¹ç”¨åˆ†æ‘Šé¢„è§ˆ -->
                    <div class="mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">ğŸ’° è´¹ç”¨åˆ†æ‘Šé¢„è§ˆ</h6>
                            </div>
                            <div class="card-body">
                                <div id="splitPreview">
                                    <p class="text-muted text-center">è¯·å…ˆé€‰æ‹©å‚ä¸è€…å’Œè¾“å…¥é‡‘é¢</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">å–æ¶ˆ</a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle"></i> ä¿å­˜ä¿®æ”¹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 2rem;
    text-align: center;
    transition: border-color 0.15s ease-in-out;
    cursor: pointer;
    background-color: #f8f9fa;
}

.file-upload-area:hover,
.file-upload-area.dragover {
    border-color: #0d6efd;
    background-color: #e7f3ff;
}

.file-preview-item {
    position: relative;
}

.file-remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.8);
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    color: white;
    font-size: 12px;
    cursor: pointer;
}

.file-remove-btn:hover {
    background: rgba(220, 53, 69, 1);
}

.bill-type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
}

#splitPreview .participant-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
}

#splitPreview .participant-item.payer {
    background-color: #e7f3ff;
    border-color: #0d6efd;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('receipts');
    const filePreviewArea = document.getElementById('filePreviewArea');
    const fileList = document.getElementById('fileList');
    const participantCheckboxes = document.querySelectorAll('.participant-checkbox');
    const amountInput = document.getElementById('amount');
    const splitPreview = document.getElementById('splitPreview');
    let selectedFiles = [];

    // ç¡®ä¿ä»˜æ¬¾äººå§‹ç»ˆè¢«é€‰ä¸­
    const payerCheckbox = document.querySelector('input[name="participants"][value="{{ bill.payer_id }}"]');
    if (payerCheckbox) {
        payerCheckbox.checked = true;
        payerCheckbox.disabled = true;
    }

    // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
    fileUploadArea.addEventListener('click', function(e) {
        if (e.target !== fileInput) {
            fileInput.click();
        }
    });

    // æ‹–æ‹½åŠŸèƒ½
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files);
        handleFileSelection(files);
    });

    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        handleFileSelection(files);
    });

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelection(files) {
        files.forEach(file => {
            if (isValidFile(file)) {
                selectedFiles.push({
                    file: file,
                    id: Date.now() + Math.random()
                });
            } else {
                alert(`æ–‡ä»¶ "${file.name}" æ ¼å¼ä¸æ”¯æŒæˆ–è¶…è¿‡å¤§å°é™åˆ¶`);
            }
        });

        updateFilePreview();
        updateFileInput();
    }

    // éªŒè¯æ–‡ä»¶
    function isValidFile(file) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
        const maxSize = 10 * 1024 * 1024; // 10MB

        return validTypes.includes(file.type) && file.size <= maxSize;
    }

    // æ›´æ–°æ–‡ä»¶é¢„è§ˆ
    function updateFilePreview() {
        if (selectedFiles.length === 0) {
            filePreviewArea.style.display = 'none';
            return;
        }

        filePreviewArea.style.display = 'block';
        fileList.innerHTML = '';

        selectedFiles.forEach((fileObj, index) => {
            const file = fileObj.file;
            const fileItem = document.createElement('div');
            fileItem.className = 'col-md-4 file-preview-item';

            const isImage = file.type.startsWith('image/');
            let previewContent = '';

            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileItem.querySelector('.file-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
                previewContent = `<img class="file-preview img-fluid rounded" src="" alt="é¢„è§ˆ" style="max-height: 100px;">`;
            } else {
                previewContent = `<div class="file-preview d-flex align-items-center justify-content-center bg-light rounded" style="height: 100px;">
                    <i class="bi bi-file-earmark-pdf" style="font-size: 2rem; color: #dc3545;"></i>
                </div>`;
            }

            fileItem.innerHTML = `
                <div class="card">
                    <div class="card-body p-2 text-center">
                        ${previewContent}
                        <small class="d-block mt-1 text-truncate">${file.name}</small>
                        <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                        <button type="button" class="file-remove-btn" onclick="removeFile(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `;

            fileList.appendChild(fileItem);
        });
    }

    // åˆ é™¤æ–‡ä»¶
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFilePreview();
        updateFileInput();
    }

    // æ›´æ–°æ–‡ä»¶è¾“å…¥æ¡†
    function updateFileInput() {
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(fileObj => {
            dataTransfer.items.add(fileObj.file);
        });
        fileInput.files = dataTransfer.files;
    }

    // è´¹ç”¨åˆ†æ‘Šè®¡ç®—
    function updateSplitPreview() {
        const amount = parseFloat(amountInput.value) || 0;
        const selectedParticipants = Array.from(document.querySelectorAll('input[name="participants"]:checked'));

        if (amount === 0 || selectedParticipants.length === 0) {
            splitPreview.innerHTML = '<p class="text-muted text-center">è¯·å…ˆé€‰æ‹©å‚ä¸è€…å’Œè¾“å…¥é‡‘é¢</p>';
            return;
        }

        const splitAmount = (amount / selectedParticipants.length).toFixed(2);
        let html = `<div class="d-flex justify-content-between align-items-center mb-3">
            <strong>æ€»é‡‘é¢ï¼šÂ¥${amount.toFixed(2)}</strong>
            <strong>æ¯äººåº”ä»˜ï¼šÂ¥${splitAmount}</strong>
        </div>`;

        selectedParticipants.forEach(checkbox => {
            // ä» data-username å±æ€§è·å–ç”¨æˆ·å
            const userName = checkbox.getAttribute('data-username');
            const isPayer = checkbox.value == '{{ bill.payer_id }}';

            html += `<div class="participant-item ${isPayer ? 'payer' : ''}">
                <span>${userName} ${isPayer ? '(ä»˜æ¬¾äºº)' : ''}</span>
                <span class="badge ${isPayer ? 'bg-primary' : 'bg-secondary'}">
                    ${isPayer ? 'å·²ä»˜æ¬¾' : 'Â¥' + splitAmount}
                </span>
            </div>`;
        });

        splitPreview.innerHTML = html;
    }

    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    amountInput.addEventListener('input', updateSplitPreview);
    participantCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSplitPreview);
    });

    // è´¦å•ç±»å‹é€‰æ‹©å¤„ç†
    const billTypeRadios = document.querySelectorAll('input[name="bill_type"]');
    const descriptionInput = document.getElementById('description');

    billTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value !== 'other') {
                const typeMap = {
                    'water': 'æ°´è´¹',
                    'electricity': 'ç”µè´¹',
                    'gas': 'ç‡ƒæ°”è´¹',
                    'trash': 'åƒåœ¾è´¹',
                    'internet': 'ç½‘è´¹',
                    'shopping': 'è´­ç‰©',
                    'food': 'é¤é¥®',
                    'transportation': 'äº¤é€š'
                };
                descriptionInput.value = typeMap[this.value] || this.value;
            } else {
                descriptionInput.focus();
            }
        });
    });

    // åˆå§‹åŒ–æ—¶æ›´æ–°åˆ†æ‘Šé¢„è§ˆ
    updateSplitPreview();
});

// åˆ‡æ¢å‚ä¸è€…é€‰æ‹©çŠ¶æ€ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
function toggleParticipantEdit(userId) {
    const checkbox = document.getElementById(`user_${userId}`);
    const card = document.querySelector(`[data-user-id="${userId}"]`);
    const avatar = card.querySelector('.participant-avatar i');
    const checkIcon = card.querySelector('.bi-check-circle-fill');
    const selectionText = card.querySelector('.selection-text');

    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»˜æ¬¾äººï¼ˆä»˜æ¬¾äººä¸èƒ½å–æ¶ˆé€‰æ‹©ï¼‰
    const isPayer = userId == {{ bill.payer_id }};
    if (isPayer && checkbox.checked) {
        return; // ä»˜æ¬¾äººä¸èƒ½å–æ¶ˆé€‰æ‹©
    }

    // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
    checkbox.checked = !checkbox.checked;

    // æ›´æ–°å¡ç‰‡å¤–è§‚
    if (checkbox.checked) {
        // é€‰ä¸­çŠ¶æ€
        card.classList.remove('border-secondary');
        card.classList.add('border-success', 'bg-light');
        avatar.classList.remove('text-muted');
        avatar.classList.add('text-success');
        checkIcon.style.display = 'inline-block';
        selectionText.textContent = 'å·²é€‰æ‹©';
        selectionText.classList.remove('text-muted');
        selectionText.classList.add('text-success');
    } else {
        // æœªé€‰ä¸­çŠ¶æ€
        card.classList.remove('border-success', 'bg-light');
        card.classList.add('border-secondary');
        avatar.classList.remove('text-success');
        avatar.classList.add('text-muted');
        checkIcon.style.display = 'none';
        selectionText.textContent = 'ç‚¹å‡»é€‰æ‹©';
        selectionText.classList.remove('text-success');
        selectionText.classList.add('text-muted');
    }

    // æ›´æ–°è´¹ç”¨åˆ†æ‘Šé¢„è§ˆ
    updateSplitPreview();
}

// åˆ é™¤ç°æœ‰å‡­è¯æ–‡ä»¶
function deleteExistingReceipt(receiptId, filename) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å‡­è¯æ–‡ä»¶ "${filename}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
        return;
    }

    fetch(`/api/delete_receipt/${receiptId}`, {
        method: 'DELETE',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // åˆ é™¤æˆåŠŸï¼Œç§»é™¤UIä¸­çš„æ–‡ä»¶é¡¹
            const receiptElement = document.getElementById(`receipt-${receiptId}`);
            if (receiptElement) {
                receiptElement.remove();
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–å‡­è¯æ–‡ä»¶
            const remainingReceipts = document.querySelectorAll('#existingReceipts .col-md-6');
            if (remainingReceipts.length === 0) {
                // å¦‚æœæ²¡æœ‰å‡­è¯æ–‡ä»¶äº†ï¼Œéšè—æ•´ä¸ªç°æœ‰å‡­è¯åŒºåŸŸ
                const existingReceiptsSection = document.querySelector('#existingReceipts').closest('.mb-3');
                if (existingReceiptsSection) {
                    existingReceiptsSection.style.display = 'none';
                }
            }

            alert('å‡­è¯æ–‡ä»¶åˆ é™¤æˆåŠŸï¼');
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        console.error('åˆ é™¤è¯·æ±‚å¤±è´¥:', error);
        alert('åˆ é™¤è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    });
}
</script>
{% endblock %}